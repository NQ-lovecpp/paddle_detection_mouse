# 3.3 iOS å®æ—¶æ¨ç†éƒ¨ç½²

> æœ¬æ–‡è®°å½•å°† PicoDet-S é¼ æ ‡æ£€æµ‹æ¨¡å‹éƒ¨ç½²åˆ° iPhone å¹¶å®ç°å®æ—¶æ‘„åƒå¤´æ¨ç†çš„å®Œæ•´è¿‡ç¨‹ï¼ŒåŒ…æ‹¬å››è½®æ€§èƒ½ä¼˜åŒ–è¿­ä»£ï¼ˆä» 1 FPS åˆ°ç¨³å®š 14 FPSï¼‰çš„è¯¦ç»†æ’æŸ¥è¿‡ç¨‹ä¸è§£å†³æ–¹æ¡ˆã€‚

---

## ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯é€‰å‹](#2-æŠ€æœ¯é€‰å‹)
3. [æ€§èƒ½ç“¶é¢ˆæ’æŸ¥è¿‡ç¨‹ï¼ˆå››è½®è¿­ä»£ï¼‰](#3-æ€§èƒ½ç“¶é¢ˆæ’æŸ¥è¿‡ç¨‹å››è½®è¿­ä»£)
4. [æœ€ç»ˆæ¶æ„ï¼šå…¨åŸç”Ÿæ¨ç†ç®¡çº¿](#4-æœ€ç»ˆæ¶æ„å…¨åŸç”Ÿæ¨ç†ç®¡çº¿)
5. [æ ¸å¿ƒä»£ç è¯¦è§£](#5-æ ¸å¿ƒä»£ç è¯¦è§£)
6. [æ¨¡å‹è½¬æ¢ä¸æ‰“åŒ…](#6-æ¨¡å‹è½¬æ¢ä¸æ‰“åŒ…)
7. [è¿è¡Œæ•ˆæœ](#7-è¿è¡Œæ•ˆæœ)
8. [è¸©å‘è®°å½•](#8-è¸©å‘è®°å½•)
9. [è¿›ä¸€æ­¥ä¼˜åŒ–æ–¹å‘](#9-è¿›ä¸€æ­¥ä¼˜åŒ–æ–¹å‘)

---

## 1. é¡¹ç›®æ¦‚è¿°

**ç›®æ ‡**ï¼šåœ¨ iPhone 13 Pro ä¸Šä»¥æ‘„åƒå¤´è§†é¢‘æµä¸ºè¾“å…¥ï¼Œå®æ—¶æ£€æµ‹å®éªŒé¼ ï¼Œå¹¶åœ¨ç”»é¢ä¸Šå åŠ  bounding boxã€‚

**æœ€ç»ˆæ•ˆæœ**ï¼š
- æ¨ç†å¸§ç‡ï¼š**~14 FPS**ï¼ˆPicoDet-S 320Ã—320ï¼ŒCoreML ANE åŠ é€Ÿï¼Œç¨³å®šè¿è¡Œï¼‰
- æ¨ç†å»¶è¿Ÿï¼š**~70ms / å¸§**ï¼ˆå«å¿«ç…§ã€é¢„å¤„ç†ã€æ¨ç†ã€NMSï¼‰
- æ¨¡å‹å¤§å°ï¼š4.4 MBï¼ˆvs åŸ YOLOv3 92 MBï¼‰
- ä¼˜åŒ–è·¯å¾„ï¼š**1 FPS â†’ 2 FPS â†’ 14 FPSï¼ˆå†·æœºï¼‰â†’ 14 FPSï¼ˆçƒ­æœºç¨³å®šï¼‰**ï¼Œå…±å››è½®è¿­ä»£

**æŠ€æœ¯æ ˆ**ï¼š
- å‰ç«¯ï¼šReact Nativeï¼ˆTypeScriptï¼‰
- æ‘„åƒå¤´ï¼š`react-native-vision-camera`
- æ¨ç†å¼•æ“ï¼šONNX Runtime C APIï¼ˆé€šè¿‡ `onnxruntime-c` CocoaPodï¼‰
- ç¡¬ä»¶åŠ é€Ÿï¼šCoreMLï¼ˆApple Neural Engine / ANEï¼‰
- å›¾åƒå¤„ç†ï¼šAccelerate.frameworkï¼ˆvDSPï¼‰

---

## 2. æŠ€æœ¯é€‰å‹

### 2.1 ä¸ºä»€ä¹ˆç”¨ ONNX è€Œä¸æ˜¯ CoreML åŸç”Ÿæ ¼å¼ï¼Ÿ

PaddleDetection è®­ç»ƒçš„æ¨¡å‹å¯ä»¥é€šè¿‡ `paddle2onnx` è½¬ä¸ºæ ‡å‡† ONNX æ ¼å¼ï¼Œå†ç”± ONNX Runtime çš„ CoreML Execution Provider åœ¨ iPhone çš„ ANE ä¸Šè¿è¡Œï¼Œæ— éœ€æ‰‹åŠ¨è½¬æ¢ä¸º `.mlpackage`ã€‚

```
PaddleDetection æ¨¡å‹
    â†“ paddle2onnx
ONNX æ¨¡å‹ (.onnx)
    â†“ ONNX Runtime CoreML EP
Apple Neural Engine (ANE)
```

### 2.2 ä¸ºä»€ä¹ˆé€‰ PicoDet-S è€Œä¸æ˜¯ YOLOv3ï¼Ÿ

| æ¨¡å‹ | å¤§å° | iPhone CPU æ¨ç† | CoreML ANE æ¨ç† |
|------|------|-----------------|-----------------|
| YOLOv3 + MobileNetV1 | 92 MB | ~2000ms | ä¸å…¼å®¹ï¼ˆQLinearMul æŠ¥é”™ï¼‰|
| PicoDet-S 320Ã—320 | **4.4 MB** | ~500ms | **~50ms** |

PicoDet æ˜¯ç™¾åº¦é£æ¡¨ä¸“ä¸ºç§»åŠ¨ç«¯è®¾è®¡çš„è½»é‡æ£€æµ‹å™¨ï¼Œç»“æ„æ›´é€‚åˆ CoreMLã€‚

### 2.3 ä¸ºä»€ä¹ˆç”¨ ORT C API è€Œä¸æ˜¯ `onnxruntime-react-native`ï¼Ÿ

`onnxruntime-react-native` æä¾›äº† JavaScript è°ƒç”¨ ORT çš„èƒ½åŠ›ï¼Œä½†å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š

1. **1.2 MB bridge ä¼ è¾“**ï¼šæ¯å¸§éœ€è¦æŠŠ 320Ã—320Ã—3Ã—4 = 1.2 MB çš„ Float32 æ•°ç»„ä» Native Swift ä¼ ç»™ JSï¼ˆbase64 ç¼–ç åçº¦ 1.6 MBï¼‰ï¼Œå†ç”± JS åˆ›å»º OrtTensorï¼Œè¿™åœ¨ React Native bridge ä¸Šææ…¢ï¼ˆçº¦ 100-200msï¼‰ã€‚

2. **CoreML EP ä¸å¯é **ï¼šJS ä¾§è°ƒç”¨çš„ CoreML EP æœ‰æ—¶ä¼šé™é»˜å›é€€åˆ° CPUï¼Œæ— æ³•ç¡®ä¿ ANE åŠ é€Ÿã€‚

ç›´æ¥ä½¿ç”¨ `onnxruntime-c` CocoaPod çš„ C APIï¼Œåœ¨ Objective-C++ ä¸­å®Œæˆæ•´ä¸ªç®¡çº¿ï¼Œåªæœ‰æå°çš„æ£€æµ‹ç»“æœ JSONï¼ˆé€šå¸¸ < 1 KBï¼‰é€šè¿‡ bridge è¿”å›ã€‚

---

## 3. æ€§èƒ½ç“¶é¢ˆæ’æŸ¥è¿‡ç¨‹ï¼ˆå››è½®è¿­ä»£ï¼‰

### 3.1 ç¬¬ä¸€è½®ï¼šåˆå§‹å®ç°ï¼ˆ~1 FPSï¼‰

æœ€åˆç”¨çº¯ JavaScript åšé¢„å¤„ç†ï¼š

```
takeSnapshot â†’ [bridge] â†’ JS: jpeg-js è§£ç  + æ‰‹å†™ resize/normalize â†’ [ORT JS] â†’ ç»“æœ
é¢„å¤„ç†è€—æ—¶ï¼šçº¦ 3000-16000msï¼ˆçº¯ JSï¼Œå•çº¿ç¨‹ï¼‰
```

ç“¶é¢ˆåœ¨äº JS çº¿ç¨‹åšå¤§é‡æµ®ç‚¹è¿ç®—ï¼Œä¸”æ— æ³•åˆ©ç”¨ SIMD æŒ‡ä»¤ã€‚

### 3.2 ç¬¬äºŒè½®ï¼šSwift åŸç”Ÿé¢„å¤„ç†ï¼ˆ~2 FPSï¼‰

å°†é¢„å¤„ç†ç§»å…¥ Swiftï¼Œç”¨ Accelerate.frameworkï¼š

```
takeSnapshot â†’ [bridge] â†’ ImagePreprocessor.swift â†’ [bridge 1.2MB float] â†’ ORT JS æ¨ç†
é¢„å¤„ç†ï¼š~5-30msï¼ˆSwift/Accelerateï¼‰
bridgeä¼ è¾“ï¼š~100ms
ORT CPU æ¨ç†ï¼š~500ms
æ€»è®¡ï¼š~600ms â†’ çº¦ 2 FPSï¼ˆå— 500ms setInterval ç¡¬æ€§é™åˆ¶ï¼‰
```

å‘ç°äº†ä¸¤ä¸ªé¢å¤–é—®é¢˜ï¼š
- ä»£ç ä¸­ `setInterval(runInference, 500)` ç›´æ¥æŠŠ FPS ä¸Šé™é”åœ¨äº† 2
- `onnxruntime-react-native` çš„ CoreML EP ä¸ç”Ÿæ•ˆï¼ˆé™é»˜å›é€€ CPUï¼‰

### 3.3 ç¬¬ä¸‰è½®ï¼šå…¨åŸç”Ÿ C++ ç®¡çº¿ï¼ˆ~14 FPS å†·æœºï¼‰ âœ…

æŠŠæ•´ä¸ªç®¡çº¿æ¬è¿›ä¸€ä¸ª Objective-C++ æ¨¡å—ï¼Œä½¿ç”¨ ORT C API + CoreMLï¼š

```
takeSnapshot â†’ [bridge path] â†’ MouseDetector.mm:
                                   resize(CoreGraphics) â†’ normalize(Accelerate) â†’ ORT C API + CoreML ANE
                               â†’ [bridge < 1KB JSON] â†’ æ¸²æŸ“ bounding box
```

| é˜¶æ®µ | è€—æ—¶ï¼ˆå†·æœºï¼‰ |
|------|------|
| å¿«ç…§ (`takeSnapshot`) | ~15ms |
| å›¾åƒç¼©æ”¾ (CoreGraphics, kCGInterpolationMedium) | ~5ms |
| å½’ä¸€åŒ– (vDSP/Accelerate) | ~3ms |
| **ORT C API + CoreML ANE æ¨ç†** | **~40-50ms** |
| NMSï¼ˆC++ æ‰‹å†™ï¼‰ | <1ms |
| Bridge è¿”å› JSON | <1ms |
| **æ€»è®¡** | **~70ms â†’ ~14 FPS** |

ä½†å‘ç°ä¸€ä¸ªå…³é”®é—®é¢˜ï¼š**é•¿æ—¶é—´è¿è¡Œåæ€§èƒ½ä¸¥é‡ä¸‹æ»‘**ã€‚æ‰‹æœºè¿ç»­è¿è¡Œ 5 åˆ†é’Ÿåï¼Œå®æµ‹æ•°æ®å˜æˆï¼š

| é˜¶æ®µ | çƒ­æœºæ—¶è€—æ—¶ |
|------|------|
| å¿«ç…§ (`takeSnapshot`) | **60-70ms**ï¼ˆâ†‘ 4Ã—ï¼‰ |
| å›¾åƒç¼©æ”¾ | **13-16ms**ï¼ˆâ†‘ 3Ã—ï¼‰ |
| ORT ANE æ¨ç† | **94-110ms**ï¼ˆâ†‘ 2Ã—ï¼‰ |
| **å®é™… FPS** | **~1 FPS** |

è¿™æ˜¯å…¸å‹çš„ **iOS çƒ­èŠ‚æµï¼ˆThermal Throttlingï¼‰**ï¼šiPhone æ£€æµ‹åˆ° CPU/ANE æ¸©åº¦è¿‡é«˜ï¼Œä¸»åŠ¨é™é¢‘ä¿æŠ¤è®¾å¤‡ã€‚æ ¹æœ¬åŸå› æ˜¯ï¼š
1. `takeSnapshot` åœ¨ 1920Ã—1440 åŸå§‹åˆ†è¾¨ç‡ä¸‹æ‹æ‘„ï¼ŒJPEG å‹ç¼© CPU å ç”¨é«˜
2. æ¯å¸§è§£ç ä¸€å¼ å¤§å›¾å†ç¼©æ”¾ï¼ŒCPU å‹åŠ›å¤§
3. ANE æŒç»­é«˜è´Ÿè·è¿è¡Œï¼ˆæ— å–˜æ¯æ—¶é—´ï¼‰

### 3.4 ç¬¬å››è½®ï¼šé¢„å¤„ç†/è°ƒåº¦å…¨é¢ä¼˜åŒ–ï¼ˆ~14 FPS çƒ­æœºç¨³å®šï¼‰

**ç›®æ ‡**ï¼šä¸æ”¹æ¨¡å‹ï¼Œæ¶ˆé™¤çƒ­èŠ‚æµï¼Œè®© 14 FPS åœ¨çƒ­æœºçŠ¶æ€ä¸‹ä¹Ÿèƒ½ç»´æŒã€‚

#### 3.4.1 è°ƒè¯•å·¥å…·ï¼šå»ºç«‹ç²¾å‡† Timing æ—¥å¿—

ä¼˜åŒ–ä¹‹å‰ï¼Œå…ˆè§£å†³"çœ‹ä¸åˆ°æ•°æ®"çš„é—®é¢˜ã€‚

**æ–¹æ¡ˆä¸€ï¼ˆæœ€ç»ˆç”¨ï¼‰ï¼šMac ç«¯ HTTP æ—¥å¿—æœåŠ¡å™¨**

```javascript
// Mobile_Deployment/MouseDetectionApp/log-server.js
const http = require('http');
http.createServer((req, res) => {
    let body = '';
    req.on('data', d => body += d);
    req.on('end', () => { console.log(JSON.parse(body).message); res.end('ok'); });
}).listen(8082);
```

App ç«¯æ¯ 5 å¸§é€šè¿‡ `fetch` POST ä¸€æ¬¡ timing æ•°æ®åˆ° Macï¼š

```
â„¹ï¸ [02:36:49] snap=38ms resize=8ms norm=2.6ms infer=47ms nms=0ms total=58ms
```

**æ–¹æ¡ˆäºŒï¼ˆå¤‡ç”¨ï¼‰ï¼š`idevicesyslog`**

```bash
brew install libimobiledevice
idevicesyslog -u <UDID> --process MouseDetectionApp 2>/dev/null | grep "\[MouseDetector\]"
```

åœ¨ `MouseDetector.mm` çš„ `detect` æ–¹æ³•æœ«å°¾åŠ  `NSLog(@"[MouseDetector] %@ dets=%lu", timings, ...)` å³å¯åœ¨ç»ˆç«¯å®æ—¶çœ‹åˆ°æ¯å¸§è€—æ—¶ã€‚

#### 3.4.2 çƒ­æœºè€—æ—¶æ•°æ®åˆ†æ

é€šè¿‡æ—¥å¿—æœåŠ¡å™¨æ”¶é›†åˆ°çš„ç¨³å®šçŠ¶æ€æ•°æ®ï¼ˆçƒ­æœº 5 åˆ†é’Ÿåï¼‰ï¼š

```
snap=60ms  resize=14ms  norm=3ms  infer=100ms  total=177ms JS â†’ çº¦ 1 FPSï¼ˆæå·®ï¼‰
snap=63ms  resize=15ms  norm=3ms  infer=95ms   total=178ms JS
snap=65ms  resize=14ms  norm=3ms  infer=110ms  total=192ms JS
```

ä¸å†·æœºæ•°æ®å¯¹æ¯”ï¼Œå‘ç°æ‰€æœ‰é˜¶æ®µéƒ½åœ¨ 2-4Ã— èŒƒå›´å†…é™é€Ÿï¼Œè¯´æ˜æ˜¯å…¨å±€çƒ­èŠ‚æµï¼Œè€ŒéæŸä¸€æ¨¡å—çš„é—®é¢˜ã€‚

#### 3.4.3 ä¼˜åŒ–ä¸€ï¼šé™ä½æ‘„åƒå¤´åˆ†è¾¨ç‡ï¼ˆsnap 60ms â†’ 38msï¼‰

æ ¹æœ¬åŸå› ï¼š`takeSnapshot` åœ¨å…¨åˆ†è¾¨ç‡ï¼ˆ1920Ã—1440ï¼‰ä¸‹å·¥ä½œï¼ŒJPEG encode æ…¢ï¼Œåç»­ decode + resize ä¹Ÿæ…¢ã€‚

**è§£æ³•**ï¼šä½¿ç”¨ `useCameraFormat` å¼ºåˆ¶æŒ‡å®š 720p 60fps æ ¼å¼ï¼Œæºå›¾åƒåƒç´ æ•°å‡å°‘ 6Ã—ï¼ŒJPEG æ–‡ä»¶ä» ~80KB é™åˆ° ~20KBã€‚

```typescript
// DetectionScreen.tsx
import { useCameraFormat } from 'react-native-vision-camera';

const format = useCameraFormat(device, [
    { videoResolution: { width: 1280, height: 720 } },
    { fps: 60 },
]);

<Camera
    format={format}
    fps={format?.maxFps ?? 30}
    // ...
/>
```

æ•ˆæœï¼š
- `snap`ï¼š60ms â†’ **38ms**ï¼ˆ-37%ï¼‰
- `resize`ï¼š14ms â†’ **8ms**ï¼ˆ-43%ï¼‰
- `infer`ï¼š100ms â†’ **47ms**ï¼ˆ-53%ï¼Œçƒ­èŠ‚æµå¤§å¹…å‡è½»ï¼‰

#### 3.4.4 ä¼˜åŒ–äºŒï¼šé™ä½ JPEG å¿«ç…§è´¨é‡ï¼ˆsnap è¿›ä¸€æ­¥ä¼˜åŒ–ï¼‰

```typescript
// è´¨é‡ä» 50 é™åˆ° 25ï¼Œæ–‡ä»¶æ›´å°ï¼Œencode/decode æ›´å¿«
// å¯¹ 320Ã—320 æ£€æµ‹ä»»åŠ¡è€Œè¨€ï¼ŒJPEG è´¨é‡ 25 å®Œå…¨è¶³å¤Ÿ
const photo = await cameraRef.current.takeSnapshot({ quality: 25 });
```

ä¸é™åˆ†è¾¨ç‡é…åˆåï¼Œå•å¸§ JPEG æ–‡ä»¶ä» ~80KB é™è‡³ ~15KBã€‚

#### 3.4.5 ä¼˜åŒ–ä¸‰ï¼šPipelineâ€”â€”å¿«ç…§ä¸æ¨ç†å¹¶è¡Œæ‰§è¡Œ

**åŸæ¥çš„ä¸²è¡Œæ‰§è¡Œ**ï¼ˆsnap å’Œ detect é¡ºåºæ‰§è¡Œï¼‰ï¼š

```
å¸§ 1: [snap 38ms][detect 53ms]
å¸§ 2:                         [snap 38ms][detect 53ms]
å¸§ N: æ¯å¸§ 91msï¼ŒFPS = 11
```

**æ”¹ä¸º Pipeline**ï¼ˆä¸‹ä¸€å¸§ snap ä¸å½“å‰å¸§ detect å¹¶è¡Œï¼‰ï¼š

```
å¸§ 1: [snap 38ms][detect 53ms]
å¸§ 2:      [snap2é¢„å–(38ms)] å·²ç»å®Œæˆ â†’ detect ç«‹å³å¼€å§‹
å¸§ N: æœ‰æ•ˆå¸§æ—¶é—´ = max(snap, detect) = 53msï¼ŒFPS = 19
```

å®ç°æ–¹å¼ï¼šåœ¨ `detect` å¼€å§‹çš„åŒæ—¶ï¼Œç«‹å³è§¦å‘ä¸‹ä¸€å¸§çš„ `takeSnapshot`ï¼Œç”¨ `pendingSnapRef` æŒæœ‰è¿™ä¸ª Promiseï¼š

```typescript
// DetectionScreen.tsx
const pendingSnapRef = useRef<ReturnType<Camera['takeSnapshot']> | null>(null);

const runInference = useCallback(async () => {
    // ä½¿ç”¨ä¸Šä¸€å¸§é¢„å–çš„å¿«ç…§ï¼ˆå·²åœ¨ detect æœŸé—´å®Œæˆï¼‰
    const photoPromise = pendingSnapRef.current
        ?? cameraRef.current.takeSnapshot({ quality: 25 });

    // ç«‹å³å‘èµ·ä¸‹ä¸€å¸§å¿«ç…§ï¼ˆä¸æœ¬å¸§ detect å¹¶è¡Œè¿è¡Œï¼‰
    pendingSnapRef.current = cameraRef.current.takeSnapshot({ quality: 25 });

    const photo = await photoPromise;
    const snapMs = Date.now() - t0; // å¦‚æœé¢„å–æˆåŠŸï¼Œæ­¤å€¼æ¥è¿‘ 0

    const native = await MouseDetector.detect(photo.path, threshold);

    // fire-and-forgetï¼šä¸ç­‰å¾…æ–‡ä»¶åˆ é™¤ï¼Œä¸é˜»å¡ä¸‹ä¸€å¸§
    RNFS.unlink(photo.path).catch(() => {});

    // ...æ¸²æŸ“ç»“æœ
}, [modelReady, threshold, addLog]);
```

åœæ­¢æ£€æµ‹æ—¶æ¸…ç†é¢„å–å¿«ç…§ï¼š

```typescript
if (pendingSnapRef.current) {
    pendingSnapRef.current
        .then(p => RNFS.unlink(p.path).catch(() => {}))
        .catch(() => {});
    pendingSnapRef.current = null;
}
```

#### 3.4.6 ä¼˜åŒ–å››ï¼šåŸç”Ÿ resize æ’å€¼æ–¹å¼ï¼ˆresize 8ms â†’ 7msï¼‰

å°† CoreGraphics æ’å€¼ä» `kCGInterpolationMedium` æ”¹ä¸º `kCGInterpolationLow`ï¼š

```objc
// MouseDetector.mm
// kCGInterpolationLow å¯¹äº 320Ã—320 ç›®æ ‡åˆ†è¾¨ç‡çš„æ£€æµ‹ä»»åŠ¡å·²è¶³å¤Ÿ
// é€Ÿåº¦çº¦å¿« 15%ï¼Œå¯¹ç²¾åº¦æ— æ˜æ˜¾å½±å“
CGContextSetInterpolationQuality(ctx, kCGInterpolationLow);
```

#### 3.4.7 ä¼˜åŒ–äº”ï¼šå‡å°‘ React æ¸²æŸ“å¼€é”€

**é—®é¢˜**ï¼šæ¯å¸§æ‰§è¡Œ 5 æ¬¡ç‹¬ç«‹ `setState`ï¼ˆdetectionsã€imageDimsã€fpsã€statusã€allDetectionsï¼‰ï¼Œè§¦å‘ 5 æ¬¡ React reconciliationï¼Œåœ¨æµ‹é‡çª—å£å¤–é€ æˆçº¦ 78ms/å¸§çš„éšæ€§å¼€é”€ã€‚

**è§£æ³•ä¸€**ï¼šå°†ä¸éœ€è¦è§¦å‘æ¸²æŸ“çš„çŠ¶æ€æ”¹ä¸º `useRef`ï¼š

```typescript
// allDetections ä»…åœ¨æ»‘å—æ”¹å˜æ—¶ç”¨åˆ°ï¼Œä¸éœ€è¦è§¦å‘ render
const allDetectionsRef = useRef<Detection[]>([]);

// handleThresholdChange ä¸­ç›´æ¥è¯» ref
const handleThresholdChange = useCallback((val: number) => {
    setThreshold(val);
    setDetections(allDetectionsRef.current.filter(d => d.confidence >= val));
}, []);
```

**è§£æ³•äºŒ**ï¼šç”¨ `unstable_batchedUpdates` æŠŠå‰©ä½™ 4 æ¬¡ setState åˆå¹¶ä¸º 1 æ¬¡ renderï¼š

```typescript
import { unstable_batchedUpdates } from 'react-native';

unstable_batchedUpdates(() => {
    setImageDims({ width: native.originalWidth, height: native.originalHeight });
    setDetections(results);
    if (frameCount % 3 === 1) { // FPS æ˜¾ç¤ºæ¯ 3 å¸§æ›´æ–°ä¸€æ¬¡ï¼Œé¿å…é¢‘ç¹ re-render
        setFps(Math.round(1000 / totalMs));
        setStatus(`${results.length} ä¸ªç›®æ ‡ | ${totalMs}ms`);
    }
});
```

**è§£æ³•ä¸‰**ï¼š`BoundingBoxOverlay` ç”¨ `React.memo` åŒ…è£¹ï¼Œä»…åœ¨ detections çœŸæ­£å˜åŒ–æ—¶é‡ç»˜ï¼š

```typescript
// BoundingBoxOverlay.tsx
export const BoundingBoxOverlay: React.FC<Props> = memo(({ detections, ... }) => {
    // FPS æˆ– status æ›´æ–°æ—¶ï¼Œæ­¤ç»„ä»¶ä¸ä¼šé‡æ–°æ¸²æŸ“
    ...
});
```

#### 3.4.8 ç¬¬å››è½®ä¼˜åŒ–å‰åå®Œæ•´å¯¹æ¯”

| é˜¶æ®µ | ä¼˜åŒ–å‰ï¼ˆçƒ­æœº 5 åˆ†é’Ÿï¼‰ | ä¼˜åŒ–åï¼ˆçƒ­æœºç¨³å®šè¿è¡Œï¼‰ | æå‡ |
|------|----------------------|----------------------|------|
| `snap`ï¼ˆå¿«ç…§ï¼‰ | 60-70ms | **35-38ms** | -43% |
| `resize`ï¼ˆç¼©æ”¾ï¼‰ | 13-16ms | **7-8ms** | -47% |
| `norm`ï¼ˆå½’ä¸€åŒ–ï¼‰ | 3-4ms | **2.1-2.3ms** | -38% |
| `infer`ï¼ˆANE æ¨ç†ï¼‰ | 94-110ms | **41-47ms** | -57% |
| `nms` | <1ms | <1ms | â€” |
| **æ€»è®¡ï¼ˆnativeï¼‰** | **124ms** | **53ms** | **-57%** |
| **æ€»è®¡ï¼ˆJS å…¨é“¾è·¯ï¼‰** | **~180ms** | **~90ms** | **-50%** |
| **å®é™… FPS** | **~1 FPS** | **~14 FPS** | **+1300%** |

> çƒ­èŠ‚æµå¤§å¹…å‡è½»çš„æ ¹æœ¬åŸå› ï¼š720p æºå›¾åƒçš„ CPU å¤„ç†é‡è¿œå°äº 1920Ã—1440ï¼Œæ•´æœºçƒ­è´Ÿè·ä¸‹é™ï¼ŒANE å¾—ä»¥ç»´æŒå…¨é€Ÿè¿è¡Œã€‚

---

## 4. æœ€ç»ˆæ¶æ„ï¼šå…¨åŸç”Ÿæ¨ç†ç®¡çº¿

### 4.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   React Native JS å±‚                         â”‚
â”‚                                                             â”‚
â”‚  DetectionScreen.tsx                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Pipeline æ¨ç†å¾ªç¯                                    â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  å¸§ N-1: [snap N-1]â”€â”€[detect N-1]                   â”‚   â”‚
â”‚  â”‚  å¸§ N:         [snap Nï¼ˆé¢„å–ï¼‰]â”€â”€[detect N]           â”‚   â”‚
â”‚  â”‚  å¸§ N+1:                  [snap N+1ï¼ˆé¢„å–ï¼‰]â”€â”€[...]   â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  snap = camera.takeSnapshot({ quality:25 })         â”‚   â”‚
â”‚  â”‚        â†’ 720p JPEGï¼ˆ~15KBï¼‰å†™å…¥ä¸´æ—¶æ–‡ä»¶              â”‚   â”‚
â”‚  â”‚  detect = MouseDetector.detect(path, threshold)     â”‚   â”‚
â”‚  â”‚        â†’ è¿”å› JSONï¼ˆ<1KBï¼‰                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ RN Bridgeï¼ˆæ–‡ä»¶è·¯å¾„ â†’ æ£€æµ‹ç»“æœ JSONï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                MouseDetector.mm (Objective-C++)              â”‚
â”‚                                                             â”‚
â”‚  1. NSData è¯» JPEG æ–‡ä»¶ â†’ UIImage                           â”‚
â”‚  2. CoreGraphics â†’ ç¼©æ”¾åˆ° 320Ã—320 RGBA                       â”‚
â”‚     ï¼ˆkCGInterpolationLowï¼Œé€Ÿåº¦ä¼˜å…ˆï¼‰                        â”‚
â”‚  3. Accelerate vDSP â†’ UInt8 RGBA â†’ Float32 CHW              â”‚
â”‚     ï¼ˆImageNet å½’ä¸€åŒ–ï¼šmean/stdï¼ŒvDSP å‘é‡åŒ–ï¼Œå»äº¤é”™ï¼‰        â”‚
â”‚  4. ORT C API â†’ CreateTensorWithDataAsOrtValueï¼ˆé›¶æ‹·è´ï¼‰      â”‚
â”‚  5. CoreML EP (COREML_FLAG_CREATE_MLPROGRAM) â†’ ANE æ¨ç†      â”‚
â”‚  6. è§£æ boxes[1,2125,4] + scores[1,2,2125]                 â”‚
â”‚  7. Per-class Greedy NMSï¼ˆC++ï¼‰                              â”‚
â”‚  8. è¿”å›æ£€æµ‹æ¡†æ•°ç»„ + timing å­—ç¬¦ä¸²ï¼ˆJSONï¼‰                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ ORT C API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           onnxruntime-c (CocoaPod xcframework)               â”‚
â”‚           CoreML Execution Provider                         â”‚
â”‚           Apple Neural Engine (ANE)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ç›®å½•ç»“æ„

```
Mobile_Deployment/MouseDetectionApp/
â”œâ”€â”€ ios/
â”‚   â”œâ”€â”€ MouseDetectionApp/
â”‚   â”‚   â”œâ”€â”€ AppDelegate.swift
â”‚   â”‚   â”œâ”€â”€ MouseDetector.mm          â† æ ¸å¿ƒï¼šå…¨åŸç”Ÿæ¨ç†æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ ImagePreprocessor.swift   â† æ—§ç‰ˆï¼ˆå·²ä¸ä½¿ç”¨ï¼Œä¿ç•™å‚è€ƒï¼‰
â”‚   â”‚   â”œâ”€â”€ ImagePreprocessor.m       â† æ—§ç‰ˆæ¡¥æ¥å¤´
â”‚   â”‚   â””â”€â”€ Resources/
â”‚   â”‚       â”œâ”€â”€ picodet_s_320_mouse_L1_nonms.onnx  â† æ¨¡å‹æ–‡ä»¶
â”‚   â”‚       â””â”€â”€ label_list.txt
â”‚   â””â”€â”€ Podfile
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â””â”€â”€ DetectionScreen.tsx       â† ä¸»å±å¹•ï¼Œè°ƒç”¨åŸç”Ÿæ¨¡å—
â”‚   â””â”€â”€ components/
â”‚       â”œâ”€â”€ BoundingBoxOverlay.tsx    â† è¾¹æ¡†å åŠ å±‚
â”‚       â”œâ”€â”€ DebugConsole.tsx          â† è°ƒè¯•æ—¥å¿—é¢æ¿
â”‚       â””â”€â”€ ThresholdSlider.tsx       â† ç½®ä¿¡åº¦é˜ˆå€¼æ»‘å—
â””â”€â”€ package.json
```

---

## 5. æ ¸å¿ƒä»£ç è¯¦è§£

### 5.1 MouseDetector.mm â€” åŸç”Ÿæ¨ç†æ¨¡å—

è¿™æ˜¯æ•´ä¸ªæ–¹æ¡ˆçš„æ ¸å¿ƒï¼Œç”¨ Objective-C++ï¼ˆ`.mm` æ–‡ä»¶ï¼‰å†™æˆï¼Œå¯ä»¥åŒæ—¶è°ƒç”¨ ORT C APIï¼ˆC++ï¼‰å’Œ iOS æ¡†æ¶ï¼ˆObjCï¼‰ã€‚

**å…³é”® importï¼š**
```objc
#import <UIKit/UIKit.h>           // UIImage åŠ è½½å›¾ç‰‡
#import <Accelerate/Accelerate.h> // vDSP å‘é‡åŒ–å½’ä¸€åŒ–
#import <onnxruntime/onnxruntime_c_api.h>      // ORT C API
#import <onnxruntime/coreml_provider_factory.h> // CoreML EP
#include <vector>     // std::vector for NMS
#include <algorithm>  // std::sort
```

**åˆå§‹åŒ–ï¼ˆåŠ è½½æ¨¡å‹ï¼Œå¯ç”¨ CoreMLï¼‰ï¼š**
```objc
// åˆ›å»º ORT Session Options
OrtSessionOptions* opts;
_api->CreateSessionOptions(&opts);
_api->SetSessionGraphOptimizationLevel(opts, ORT_ENABLE_ALL);

// å¯ç”¨ CoreML Execution Providerï¼ˆMLProgram æ ¼å¼ï¼Œå……åˆ†åˆ©ç”¨ ANEï¼‰
// ä¸æ”¯æŒçš„ç®—å­è‡ªåŠ¨å›é€€ CPUï¼Œä¸ä¼šæŠ¥é”™
OrtSessionOptionsAppendExecutionProvider_CoreML(opts, COREML_FLAG_CREATE_MLPROGRAM);

// ä» .onnx æ–‡ä»¶åˆ›å»ºæ¨ç† Session
const char* path = [modelPath UTF8String];
_api->CreateSession(_env, path, opts, &_session);
```

**å›¾åƒé¢„å¤„ç†ï¼ˆCoreGraphics + Accelerateï¼‰ï¼š**
```objc
// 1. ç¼©æ”¾åˆ° 320Ã—320ï¼Œåƒç´ å†™å…¥ RGBA buffer
std::vector<uint8_t> pixels(320 * 320 * 4);
CGContextRef ctx = CGBitmapContextCreate(pixels.data(), 320, 320, 8, 320*4,
                                         CGColorSpaceCreateDeviceRGB(),
                                         kCGImageAlphaNoneSkipLast);
CGContextSetInterpolationQuality(ctx, kCGInterpolationMedium);
CGContextDrawImage(ctx, CGRectMake(0, 0, 320, 320), uiImage.CGImage);

// 2. RGBA UInt8 â†’ CHW Float32ï¼ŒåŒæ—¶åš ImageNet å½’ä¸€åŒ–
// vDSP_vfltu8 ç”¨ stride=4 ç›´æ¥ä» RGBA æå–å„é€šé“ï¼Œä¸€æ¬¡å®Œæˆå»äº¤é”™å’Œç±»å‹è½¬æ¢
std::vector<float> chw(3 * 320 * 320);
vDSP_vfltu8(pixels.data() + 0, 4, chw.data(),              1, 320*320); // R
vDSP_vfltu8(pixels.data() + 1, 4, chw.data() + 320*320,    1, 320*320); // G
vDSP_vfltu8(pixels.data() + 2, 4, chw.data() + 2*320*320,  1, 320*320); // B

// vDSP_vsmsa åš fused multiply-addï¼špixel = pixel * scale + offset
// ç­‰ä»·äºï¼š(pixel / 255 - mean) / stdï¼Œå…¨å‘é‡åŒ–
for (int c = 0; c < 3; c++) {
    float scale  = 1.0f / (255.0f * kStd[c]);   // ImageNet std
    float offset = -kMean[c] / kStd[c];          // ImageNet mean
    vDSP_vsmsa(chw.data() + c*320*320, 1, &scale, &offset,
               chw.data() + c*320*320, 1, 320*320);
}
```

**ORT C API æ¨ç†ï¼š**
```objc
// å°† CHW float æ•°ç»„åŒ…è£…ä¸º OrtValueï¼ˆé›¶æ‹·è´ï¼Œç›´æ¥å¼•ç”¨ chw.data()ï¼‰
int64_t shape[] = {1, 3, 320, 320};
OrtValue* inputTensor;
_api->CreateTensorWithDataAsOrtValue(
    _memInfo,
    chw.data(), chw.size() * sizeof(float),
    shape, 4,
    ONNX_TENSOR_ELEMENT_DATA_TYPE_FLOAT,
    &inputTensor);

// è¿è¡Œæ¨ç†
const char* inputNames[]  = {"image"};
const char* outputNames[] = {"boxes", "scores"};
OrtValue* outputs[2] = {nullptr, nullptr};
_api->Run(_session, nullptr,
          inputNames, &inputTensor, 1,
          outputNames, 2, outputs);

// ç›´æ¥è¯»å–è¾“å‡ºæŒ‡é’ˆï¼ˆé›¶æ‹·è´ï¼‰
float* boxData;   _api->GetTensorMutableData(outputs[0], (void**)&boxData);
float* scoreData; _api->GetTensorMutableData(outputs[1], (void**)&scoreData);
```

**è¾“å‡ºæ ¼å¼ï¼ˆPicoDet-S nonms æ¨¡å‹ï¼‰ï¼š**

| å¼ é‡å | å½¢çŠ¶ | å«ä¹‰ |
|--------|------|------|
| `boxes` | [1, 2125, 4] | å„ anchor é¢„æµ‹æ¡†ï¼Œxyxy æ ¼å¼ï¼Œåæ ‡åœ¨ 320px ç©ºé—´å†… |
| `scores` | [1, 2, 2125] | å„ anchor å„ç±»åˆ«ç½®ä¿¡åº¦ï¼Œchannels-first |

2125 = 40Ã—40 + 20Ã—20 + 10Ã—10 + 5Ã—5ï¼ˆPicoDet 4 çº§ FPNï¼‰

**Per-class Greedy NMSï¼ˆC++ï¼‰ï¼š**
```cpp
// æŒ‰ç±»åˆ«åˆ†ç»„ â†’ æŒ‰ç½®ä¿¡åº¦é™åºæ’åˆ— â†’ è´ªå¿ƒæŠ‘åˆ¶
for (int cls = 0; cls < kNumClasses; cls++) {
    std::vector<Candidate*> cc;
    for (auto& c : candidates) if (c.classId == cls) cc.push_back(&c);
    std::sort(cc.begin(), cc.end(), [](auto* a, auto* b){ return a->score > b->score; });

    std::vector<bool> suppressed(cc.size(), false);
    for (size_t i = 0; i < cc.size(); i++) {
        if (suppressed[i]) continue;
        // ä¿ç•™ cc[i]ï¼ŒæŠ‘åˆ¶ä¸å…¶ IoU > 0.5 çš„æ¡†
        for (size_t j = i+1; j < cc.size(); j++) {
            if (!suppressed[j] && iou(cc[i], cc[j]) > 0.5f)
                suppressed[j] = true;
        }
    }
}
```

### 5.2 DetectionScreen.tsx â€” å‰ç«¯è°ƒç”¨

**åˆå§‹åŒ–ï¼ˆåŠ è½½æ¨¡å‹ï¼‰ï¼š**
```typescript
const { MouseDetector } = NativeModules;

useEffect(() => {
    const modelPath = `${RNFS.MainBundlePath}/picodet_s_320_mouse_L1_nonms.onnx`;
    MouseDetector.initialize(modelPath);  // å¼‚æ­¥ï¼ŒCoreML ç¼–è¯‘æ¨¡å‹ï¼ˆé¦–æ¬¡è¾ƒæ…¢ï¼‰
}, []);
```

**æ‘„åƒå¤´æ ¼å¼é€‰æ‹©ï¼ˆ720p 60fpsï¼Œé™ä½çƒ­è´Ÿè·ï¼‰ï¼š**
```typescript
import { useCameraFormat } from 'react-native-vision-camera';

// ä¼˜å…ˆé€‰æ‹© 720p åˆ†è¾¨ç‡ + æœ€é«˜å¸§ç‡ï¼Œå‡å°‘æºå›¾åƒå¤§å°
const format = useCameraFormat(device, [
    { videoResolution: { width: 1280, height: 720 } },
    { fps: 60 },
]);

<Camera
    format={format}
    fps={format?.maxFps ?? 30}
    photo={true}
    video={true}
    // ...
/>
```

**Pipelined æ¨ç†å¾ªç¯ï¼ˆå¿«ç…§ä¸æ¨ç†å¹¶è¡Œï¼‰ï¼š**
```typescript
// Pipeline æ ¸å¿ƒï¼špendingSnapRef æŒæœ‰ä¸Šä¸€å¸§è§¦å‘çš„å¿«ç…§ Promise
const pendingSnapRef = useRef<ReturnType<Camera['takeSnapshot']> | null>(null);

const runInference = useCallback(async () => {
    const t0 = Date.now();

    // å¤ç”¨ä¸Šä¸€å¸§é¢„å–çš„å¿«ç…§ï¼ˆdetect è¿è¡ŒæœŸé—´å·²å®Œæˆï¼‰
    const photoPromise = pendingSnapRef.current
        ?? cameraRef.current.takeSnapshot({ quality: 25 });

    // ç«‹å³å‘èµ·ä¸‹ä¸€å¸§å¿«ç…§ï¼Œä¸æœ¬å¸§ detect å¹¶è¡Œè¿è¡Œ
    pendingSnapRef.current = cameraRef.current.takeSnapshot({ quality: 25 });

    const photo = await photoPromise;
    const snapMs = Date.now() - t0;

    // ä¸€æ¬¡ bridge è°ƒç”¨å®Œæˆå…¨éƒ¨åŸç”Ÿå·¥ä½œï¼Œè¿”å›æå° JSON
    const native = await MouseDetector.detect(photo.path, threshold);
    const totalMs = Date.now() - t0;

    // fire-and-forgetï¼šä¸é˜»å¡ä¸‹ä¸€å¸§
    RNFS.unlink(photo.path).catch(() => {});

    // æ‰¹é‡æ›´æ–°ï¼Œåˆå¹¶ä¸º 1 æ¬¡ React renderï¼ˆå‡å°‘ re-render å¼€é”€ï¼‰
    unstable_batchedUpdates(() => {
        setImageDims({ width: native.originalWidth, height: native.originalHeight });
        setDetections(native.detections.map(b => ({
            classId: b.classId, className: b.className,
            confidence: b.confidence,
            bbox: { x1: b.x1, y1: b.y1, x2: b.x2, y2: b.y2 },
        })));
        if (frameCount % 3 === 1) {
            setFps(Math.round(1000 / totalMs));
            setStatus(`${native.detections.length} ä¸ªç›®æ ‡ | ${totalMs}ms`);
        }
    });
}, [modelReady, threshold, addLog]);

// å¼‚æ­¥æ¨ç†å¾ªç¯ï¼ˆæ›¿ä»£ setIntervalï¼Œæ¨ç†å®Œæˆåç«‹å³å¼€å§‹ä¸‹ä¸€å¸§ï¼‰
(async () => {
    while (loopActiveRef.current) {
        await runInference();
    }
})();
```

### 5.3 Bridge æ•°æ®é‡å¯¹æ¯”

| æ–¹æ¡ˆ | æ¯å¸§ Bridge ä¼ è¾“é‡ | ç”¨é€” |
|------|-------------------|------|
| æ—§ï¼šJS é¢„å¤„ç† + ORT JS | 1.2 MB Float32ï¼ˆbase64 1.6MBï¼‰ | é¢„å¤„ç†ç»“æœä¼ ç»™ ORT |
| æ–°ï¼šMouseDetector.mm | **< 1 KB JSON** | æ£€æµ‹ç»“æœï¼ˆå‡ ä¸ªæ¡†ï¼‰ |

---

## 6. æ¨¡å‹è½¬æ¢ä¸æ‰“åŒ…

### 6.1 ä» PaddleDetection å¯¼å‡º PicoDet ONNX

```bash
# åœ¨æœåŠ¡å™¨ä¸Šè®­ç»ƒå®Œæˆåï¼Œå¯¼å‡º PicoDet-S
python tools/export_model.py \
    -c configs/picodet/picodet_s_320_coco_lcnet.yml \
    --output_dir=./inference_model \
    -o weights=output/picodet_mouse/best_model.pdparams

# è½¬ä¸º ONNXï¼ˆnonms æ¨¡å¼ï¼šNMS ä¸åŒ…å«åœ¨æ¨¡å‹å†…ï¼Œç”± App è‡ªå·±åšï¼‰
paddle2onnx \
    --model_dir inference_model/picodet_s_320_mouse \
    --model_filename model.pdmodel \
    --params_filename model.pdiparams \
    --opset_version 11 \
    --save_file picodet_s_320_mouse_L1_nonms.onnx \
    --without_nms True
```

> **ä¸ºä»€ä¹ˆç”¨ `--without_nms`ï¼Ÿ**  
> åŒ…å« NMS çš„ ONNX ç®—å­ï¼ˆå¦‚ `NonMaxSuppression`ï¼‰åœ¨ CoreML ä¸Šå…¼å®¹æ€§å·®ã€‚å»æ‰ NMS åç”± App ç«¯ C++ æ‰‹å†™ Greedy NMSï¼Œæ›´é«˜æ•ˆä¸”æ— å…¼å®¹æ€§é—®é¢˜ã€‚

### 6.2 åŠ å…¥ Xcode é¡¹ç›®

1. å°† `.onnx` æ–‡ä»¶æ”¾å…¥ `ios/MouseDetectionApp/Resources/`
2. åœ¨ Xcode çš„ `project.pbxproj` ä¸­æ³¨å†Œï¼ˆå·²åœ¨ä»£ç ä¸­å®Œæˆï¼Œè§ `PBXBuildFile` å’Œ `PBXResourcesBuildPhase`ï¼‰
3. æˆ–è€…ç›´æ¥åœ¨ Xcode ä¸­æ‹–å…¥å¹¶å‹¾é€‰"Add to target: MouseDetectionApp"

### 6.3 CocoaPods é…ç½®

`onnxruntime-c` ç”± `onnxruntime-react-native` çš„ podspec è‡ªåŠ¨å¼•å…¥ï¼Œæ— éœ€æ‰‹åŠ¨æ·»åŠ ã€‚éªŒè¯å·²å®‰è£…ï¼š

```bash
ls ios/Pods/onnxruntime-c/onnxruntime.xcframework/
# åº”è¯¥çœ‹åˆ°: ios-arm64/  ios-arm64_x86_64-simulator/  macos-arm64_x86_64/
```

---

## 7. è¿è¡Œæ•ˆæœ

### 7.1 å¯åŠ¨åº”ç”¨

```bash
# ç¼–è¯‘å¹¶éƒ¨ç½²åˆ° iPhoneï¼ˆæ›¿æ¢æˆä½ çš„è®¾å¤‡ UDIDï¼‰
npx react-native run-ios --device "00008110-001168A13C86401E"

# å¦å¼€ç»ˆç«¯ï¼Œå¯åŠ¨è¿œç¨‹æ—¥å¿—æœåŠ¡ï¼ˆåœ¨ Mac ç«¯çœ‹è°ƒè¯•æ—¥å¿—ï¼‰
cd Mobile_Deployment/MouseDetectionApp
node log-server.js
```

é¦–æ¬¡è¿è¡Œæ—¶ï¼ŒCoreML ä¼šç¼–è¯‘ ONNX æ¨¡å‹ä¸º MLProgramï¼ˆçº¦ 10-30 ç§’ï¼‰ï¼Œç¼–è¯‘ç»“æœç¼“å­˜åœ¨è®¾å¤‡ä¸Šï¼Œåç»­å¯åŠ¨ç§’å¼€ã€‚

### 7.2 Debug æ—¥å¿—æ ¼å¼

Debug Console æ¯ 5 å¸§è¾“å‡ºä¸€æ¬¡è¯¦ç»†æ—¶åºï¼ŒåŒæ—¶é€šè¿‡ HTTP POST å‘é€åˆ° Mac ç»ˆç«¯ï¼š

```
snap=37ms resize=7.3ms norm=2.1ms infer=43.5ms nms=0.0ms total=53.3ms total=90ms
âœ… [0] mouse conf=87.3% (298,622,547,974)
âœ… [1] other conf=64.1% (11,-1,1084,1918)
```

æ—¥å¿—æœåŠ¡å™¨ï¼ˆMac ç«¯å®æ—¶æŸ¥çœ‹ï¼‰ï¼š
```bash
node Mobile_Deployment/MouseDetectionApp/log-server.js
# ğŸ“¡ Log server listening on http://0.0.0.0:8082/log
# â„¹ï¸ [02:36:49] snap=37ms resize=7.3ms norm=2.1ms infer=43.5ms ...
```

### 7.3 æ€§èƒ½æ•°æ®ï¼ˆiPhone 13 Proï¼‰

**æœ€ç»ˆç¨³å®šçŠ¶æ€ï¼ˆçƒ­æœºè¿ç»­è¿è¡Œï¼‰ï¼š**

| é˜¶æ®µ | è€—æ—¶ |
|------|------|
| å¿«ç…§ï¼ˆ720p JPEG q=25ï¼‰ | ~37ms |
| å›¾åƒç¼©æ”¾ï¼ˆCoreGraphics Lowï¼‰ | ~7ms |
| å½’ä¸€åŒ–ï¼ˆvDSP/Accelerateï¼‰ | ~2ms |
| **ORT C API + CoreML ANE æ¨ç†** | **~44ms** |
| NMSï¼ˆC++ Greedyï¼‰ | <1ms |
| Bridge + JS è°ƒåº¦ | ~2ms |
| **æ€»å¸§æ—¶é—´** | **~90ms** |
| **å¸§ç‡** | **~14 FPS** |
| æ¨¡å‹å†…å­˜å ç”¨ | ~15MB |

**å››è½®è¿­ä»£çš„ FPS æ¼”è¿›ï¼š**

| ç‰ˆæœ¬ | å…³é”®æ”¹åŠ¨ | çƒ­æœº FPS |
|------|---------|---------|
| v1ï¼šJS é¢„å¤„ç† | jpeg-js + æ‰‹å†™ resize | **~1 FPS** |
| v2ï¼šSwift é¢„å¤„ç† | Accelerate.framework | **~2 FPS** |
| v3ï¼šå…¨åŸç”Ÿ C++ | ORT C API + CoreML | **~14 FPSï¼ˆå†·æœºï¼‰/ ~1 FPSï¼ˆçƒ­æœºï¼‰** |
| v4ï¼šçƒ­èŠ‚æµä¼˜åŒ– | 720pæ ¼å¼ + Pipeline + æ‰¹é‡æ¸²æŸ“ | **~14 FPSï¼ˆå†·æœºå’Œçƒ­æœºå‡ç¨³å®šï¼‰** |

---

## 8. è¸©å‘è®°å½•

### 8.1 `onnxruntime-react-native` CoreML EP é™é»˜å›é€€ CPU

**ç°è±¡**ï¼šåœ¨ `InferenceSession.create(path, { executionProviders: ['coreml', 'cpu'] })` åï¼Œæ¨ç†é€Ÿåº¦å’Œçº¯ CPU ä¸€æ ·æ…¢ï¼ˆ~500msï¼‰ã€‚

**åŸå› **ï¼š`onnxruntime-react-native` çš„ CoreML EP åœ¨æŸäº›æ¨¡å‹ç»“æ„ä¸‹æ— æ³•å®Œæ•´ä»£ç†æ‰€æœ‰ç®—å­ï¼Œå›é€€åˆ° CPU æ‰§è¡Œï¼Œä¸”ä¸æŠ¥é”™ã€‚

**è§£æ³•**ï¼šä½¿ç”¨ ORT C APIï¼ˆ`onnxruntime-c` CocoaPodï¼‰ç›´æ¥è°ƒç”¨ CoreML EPï¼Œåœ¨ ObjC++ å±‚å¯ä»¥æ•è·åˆ°å®Œæ•´çš„é”™è¯¯ä¿¡æ¯å’Œå›é€€åŸå› ã€‚

### 8.2 YOLOv3 INT8 é‡åŒ–æ¨¡å‹ä¸å…¼å®¹

**ç°è±¡**ï¼š`QLinearMul node error`

**åŸå› **ï¼š`onnxruntime-react-native` å½“å‰ç‰ˆæœ¬ä¸æ”¯æŒ QDQï¼ˆQuantize-Dequantizeï¼‰æ ¼å¼çš„ INT8 ç®—å­ã€‚

**è§£æ³•**ï¼šæ¢ç”¨ PicoDet-S FP32 æ¨¡å‹ï¼ˆ4.4 MBï¼‰ï¼Œä½“ç§¯æ›´å°ä¸” CoreML å…¼å®¹ã€‚

### 8.3 `takeSnapshot` éœ€è¦ `video={true}`

**ç°è±¡**ï¼š`capture/snapshot-failed: Failed to take a Snapshot of the Preview View`

**åŸå› **ï¼š`react-native-vision-camera` çš„ `takeSnapshot` åœ¨ iOS ä¸Šéœ€è¦ video pipeline å¼€å¯ã€‚

**è§£æ³•**ï¼š
```tsx
<Camera ref={cameraRef} photo={true} video={true} ... />
```

### 8.4 setInterval å¯¼è‡´ FPS ä¸Šé™

**ç°è±¡**ï¼šå³ä½¿æ¨ç†åªéœ€ 200msï¼ŒFPS å§‹ç»ˆä¸è¶…è¿‡ 2ï¼ˆ= 1000ms / 500msï¼‰

**åŸå› **ï¼š`setInterval(runInference, 500)` æ˜¯å›ºå®šé—´éš”ï¼Œä¸ç®¡ä¸Šæ¬¡æ¨ç†æ˜¯å¦å®Œæˆæˆ–å¿«æ…¢ã€‚

**è§£æ³•**ï¼šæ”¹ä¸º `while` + `await` çš„å¼‚æ­¥å¾ªç¯ï¼Œæ¨ç†å®Œæˆåç«‹å³å¼€å§‹ä¸‹ä¸€å¸§ï¼Œå–æ¶ˆäººå·¥å»¶è¿Ÿã€‚

### 8.5 React Native Bridge 1.2 MB ä¼ è¾“ç“¶é¢ˆ

**ç°è±¡**ï¼šNative é¢„å¤„ç†å¿«ï¼ˆ5msï¼‰ï¼Œä½† JS ä¾§ `Buffer.from(base64)` è§£ç æ…¢ï¼ˆçº¦ 100msï¼‰ï¼Œä¸” bridge åºåˆ—åŒ–æœ¬èº« 50-150msã€‚

**åŸå› **ï¼š320Ã—320Ã—3Ã—4 å­—èŠ‚ = 1.2 MB çš„ Float32 æ•°ç»„ï¼Œä»¥ base64 å­—ç¬¦ä¸²ï¼ˆ1.6 MBï¼‰å½¢å¼é€šè¿‡ React Native bridge ä¼ é€’ï¼Œbridge åº•å±‚æ˜¯ JSON åºåˆ—åŒ–ï¼Œä¼ å¤§ä½“ç§¯æ•°æ®æœ¬æ¥å°±æ…¢ã€‚

**è§£æ³•**ï¼šæŠŠ ORT æ¨ç†ä¹Ÿæ¬è¿›åŸç”Ÿæ¨¡å—ï¼Œæ•°æ®å®Œå…¨åœ¨ C++ å†…æµåŠ¨ï¼Œbridge åªä¼ æ£€æµ‹ç»“æœï¼ˆ< 1 KB JSONï¼‰ã€‚

### 8.6 çƒ­èŠ‚æµå¯¼è‡´å…¨é“¾è·¯é™é€Ÿ 2-4Ã—

**ç°è±¡**ï¼šApp å†·å¯åŠ¨æ—¶ 14 FPSï¼Œè¿è¡Œ 5 åˆ†é’Ÿåé™è‡³ 1 FPSã€‚æ‰€æœ‰é˜¶æ®µï¼ˆsnap / resize / inferï¼‰å‡ç­‰æ¯”ä¾‹å˜æ…¢ã€‚

**åŸå› **ï¼šiPhone æŒç»­è¿è¡Œ ANE + æ‘„åƒå¤´ + å±å¹•ï¼ŒCPU/ANE æ¸©åº¦å‡é«˜ï¼ŒiOS è§¦å‘çƒ­èŠ‚æµï¼Œå…¨ç³»ç»Ÿé™é¢‘ã€‚

**å…³é”®æŒ‡æ ‡**ï¼šçƒ­æœºå `infer` ä» 44ms é£™å‡åˆ° 100msï¼ˆ2.3Ã—ï¼‰ï¼Œ`snap` ä» 38ms é£™å‡åˆ° 65msï¼ˆ1.7Ã—ï¼‰ã€‚

**è§£æ³•**ï¼š

1. **é™ä½æ‘„åƒå¤´åˆ†è¾¨ç‡**ï¼ˆ1920Ã—1440 â†’ 1280Ã—720ï¼‰ï¼šæºå›¾åƒå‡å° 6Ã—ï¼Œå•å¸§ CPU å¤„ç†é‡å¤§å¹…ä¸‹é™ï¼Œçƒ­äº§ç”Ÿé‡å‡å°‘ï¼ŒèŠ‚æµæ¨è¿Ÿç”šè‡³æ¶ˆå¤±ã€‚
2. **é™ä½ JPEG è´¨é‡**ï¼ˆquality 50 â†’ 25ï¼‰ï¼šå‡å°æ–‡ä»¶å°ºå¯¸ï¼Œè¿›ä¸€æ­¥é™ä½ encode/decode CPU å ç”¨ã€‚
3. ä¸¤è€…é…åˆåï¼Œçƒ­æœºç¨³å®šè¿è¡Œæ—¶ `infer` ç»´æŒåœ¨ 44msï¼Œæ¢å¤åˆ°å†·æœºæ°´å¹³ã€‚

### 8.7 `idevicesyslog` æ— æ³•æ•è· `NSLog` è¾“å‡º

**ç°è±¡**ï¼šåœ¨ `MouseDetector.mm` ä¸­ç”¨ `NSLog` è¾“å‡º timingï¼Œé€šè¿‡ `idevicesyslog` è¿‡æ»¤åçœ‹ä¸åˆ°è¿™äº›è¡Œã€‚

**åŸå› **ï¼šiOS 14+ å°† `NSLog` è·¯ç”±åˆ° Unified Logging Systemï¼ˆ`os_log`ï¼‰ï¼Œè€Œ `idevicesyslog` ä½¿ç”¨çš„æ˜¯æ—§ç‰ˆ ASL APIï¼Œæ— æ³•æ•è·æ–°æ ¼å¼æ—¥å¿—ã€‚

**è§£æ³•**ï¼šæ”¹ç”¨ HTTP log server æ–¹æ¡ˆï¼Œç”± JS å±‚é€šè¿‡ `fetch` å°† timing æ•°æ® POST åˆ° Mac ç«¯çš„ Node.js æœåŠ¡å™¨ï¼Œä¸ç³»ç»Ÿæ—¥å¿—ç³»ç»Ÿæ— å…³ã€‚

### 8.8 è¿œç¨‹æ—¥å¿—æœåŠ¡å™¨æ”¶ä¸åˆ°æ•°æ®ï¼ˆMac IP å˜åŒ–ï¼‰

**ç°è±¡**ï¼š`log-server.js` åœ¨ Mac ç«¯è¿è¡Œï¼Œä½† iPhone çš„æ—¥å¿—ä¸€æ¡éƒ½æ”¶ä¸åˆ°ã€‚

**åŸå› **ï¼šApp ä»£ç ä¸­ç¡¬ç¼–ç äº† `LOG_SERVER_URL = 'http://192.168.71.40:8082/log'`ï¼Œä½† Mac çš„ WiFi IP å·²å˜æ›´ä¸º `192.168.71.85`ã€‚

**è§£æ³•**ï¼š

```bash
# æŸ¥å½“å‰ Mac IP
ipconfig getifaddr en0

# æ›´æ–° DetectionScreen.tsx ä¸­çš„ LOG_SERVER_URL
# ç„¶åé‡æ–°éƒ¨ç½² App
```

> **æ³¨æ„**ï¼šæ¯æ¬¡åˆ‡æ¢ç½‘ç»œç¯å¢ƒåéœ€è¦é‡æ–°ç¡®è®¤ Mac IP å¹¶é‡æ–°éƒ¨ç½²ã€‚

---

## 9. è¿›ä¸€æ­¥ä¼˜åŒ–æ–¹å‘

å½“å‰ç“¶é¢ˆåˆ†æï¼ˆç¨³å®šçƒ­æœºçŠ¶æ€ï¼‰ï¼š

| ç“¶é¢ˆ | è€—æ—¶ | ä¼˜åŒ–æ½œåŠ› |
|------|------|---------|
| `infer`ï¼ˆANEï¼‰ | 44ms | ä½ï¼ˆå—æ¨¡å‹æ¶æ„å’Œç¡¬ä»¶é™åˆ¶ï¼‰ |
| `snap`ï¼ˆ720p JPEGï¼‰ | 37ms | ä¸­ï¼ˆè§ä¸‹æ–¹æ–¹æ¡ˆï¼‰ |
| React æ¸²æŸ“å¼€é”€ | ~35ms | ä¸­ï¼ˆå·²ç”¨ memo + batchedUpdates ä¼˜åŒ–ï¼‰ |

**æœ€å¤§å‰©ä½™ä¼˜åŒ–ç©ºé—´**ï¼šä½¿ç”¨ VisionCamera **Frame Processor æ’ä»¶**ï¼Œç›´æ¥åœ¨æ‘„åƒå¤´ buffer å›è°ƒé‡Œè°ƒç”¨ C++ æ¨ç†ç®¡çº¿ï¼Œå®Œå…¨æ¶ˆé™¤ JPEG encodeâ†’ç£ç›˜â†’decode è·¯å¾„ï¼ˆå½“å‰çº¦ 45msï¼‰ï¼Œç†è®ºå¸§ç‡ä¸Šé™çº¦ 20-22 FPSã€‚

å®ç°æ€è·¯ï¼š
```objc
// æ–°å»º MouseDetectorFrameProcessor.mm
// æ³¨å†Œä¸º VisionCamera frame processor plugin
// ç›´æ¥ä» CMSampleBufferRef è¯»å– YUV/BGRA åƒç´ ï¼Œè·³è¿‡ JPEG I/O
- (id)callback:(Frame*)frame withArguments:(NSDictionary*)args {
    CMSampleBufferRef buffer = frame.buffer;
    // ç›´æ¥è°ƒç”¨ MouseDetector çš„é¢„å¤„ç†+æ¨ç†ä»£ç 
    // ...
}
```

---

## å‚è€ƒèµ„æ–™

- [ONNX Runtime C API æ–‡æ¡£](https://onnxruntime.ai/docs/api/c/)
- [CoreML Execution Provider é…ç½®è¯´æ˜](https://onnxruntime.ai/docs/execution-providers/CoreML-ExecutionProvider.html)
- [PicoDet å®˜æ–¹æ–‡æ¡£](https://github.com/PaddlePaddle/PaddleDetection/tree/release/2.6/configs/picodet)
- [paddle2onnx ä½¿ç”¨è¯´æ˜](https://github.com/PaddlePaddle/Paddle2ONNX)
- [react-native-vision-camera](https://react-native-vision-camera.com/)
- [Accelerate.framework vDSP å‚è€ƒ](https://developer.apple.com/documentation/accelerate/vdsp)
